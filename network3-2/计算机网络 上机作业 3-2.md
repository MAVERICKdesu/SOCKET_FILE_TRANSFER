# 计算机网络 上机作业 3-2

> ### 协议设计 
>
> ###### UDP数据包的结构
>
> ![image-20201207192520348](C:\Users\71465\AppData\Roaming\Typora\typora-user-images\image-20201207192520348.png)
>
> - 从上到下，数据包的组成为：
>   - 8位标志位
>   - 数据包序号
>   - 有效数据长度
>   - 数据正文
>   - 校验和
> - 在本次实验中，用到了7个标志位，分别为：
>   - SK1 SK2 SK3 分别代表第1，2，3次握手，也分别代表第1，2，3次挥手
>   - ACK 表示接受到了正确的数据包
>   - FIN 表示挥手数据包
>   - SEND 表示发送数据
>   - AGAIN 表示上一个数据包有误，请求重传
> - 受到位数影响，数据包的序号需要对256进行取模，因此接受方接受到的数据包序号的范围为0~255
> - 因为采用了停传方法来进行可靠传输，在没有接收到ACK数据包时Client是不会继续发送数据包的。因此发送AGAIN数据包时不需要指定数据包序号
> - 数据包的二进制位数一定是8的整数倍数，如果数据正文不是8的整数倍数，则用0不齐。因为数据包中包含了真实的数据长度，可以还原原数据
> - 校验和采用了checksum算法，即除了最后8位，将每8位进行异或操作，结果取反作为校验和
>

------

###### 滑动窗口机制

使用了左右两个指针来确定窗口的边界，发送端和接收端使用一个大的布尔数组表示是否对应序号的数据包是否确定被接收，而且能接受序号不连续的若干数据包并存储，实现了累计确认。
对于发送端，启用了3个线程：

- 线程一用于不断接受ack数据包。如果一个ack数据包校验无误，则将相应的布尔数组的一个元素幅值为真。
- 线程二用于发送数据包，而且一定只会发送窗口最左边的那个数据包。如果窗口左端序号对应的布尔值为真，说明已经发送了，则跳过，否则发送这个数据包
- 线程三用于滑动窗口。如果窗口最左端的位置对应的布尔值为真，则将窗口右移，即左指针和右指针都加一，否则不做处理。

对于接收端，只需要不断接收数据包。接受的数据包通过校验后，则将该序号对应的布尔值为真，并返回ack数据包。